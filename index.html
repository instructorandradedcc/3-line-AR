<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: gap: content:; style-src * 'self' 'unsafe-inline'; script-src * 'self' 'unsafe-inline' 'unsafe-eval';">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3 LINE-AR | V46.2 CONNECT FIX</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { 
            theme: { 
                extend: { 
                    colors: { glass: 'rgba(5, 10, 20, 0.95)', cyber: '#00f3ff', neon: '#39ff14', hot: '#ff0055', warn: '#ffcc00', rank1: '#ffd700', rank2: '#c0c0c0', rank3: '#cd7f32' },
                    fontFamily: { orbitron: ['Orbitron', 'sans-serif'], mono: ['monospace'] },
                    animation: { 'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'spin-slow': 'spin 3s linear infinite' }
                } 
            } 
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Fuente para caracteres Chinos y Cirílicos de respaldo -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* Ajuste de fuentes para soporte multi-idioma */
        html, body { background-color: #000000; height: 100%; width: 100%; overflow: hidden; touch-action: none; } 
        body { margin: 0; user-select: none; font-family: 'Orbitron', 'Noto Sans SC', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Clases especificas para idiomas que necesitan otra fuente */
        body.lang-zh, body.lang-ru { font-family: 'Noto Sans SC', sans-serif, 'Orbitron'; letter-spacing: 0; font-weight: bold; }
        
        body.ar-active { background-color: transparent !important; }
        body.ar-active #bg-canvas { display: none !important; }
        
        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: radial-gradient(circle at center, #080810 0%, #000000 100%); pointer-events: none; }
        canvas { display: block; outline: none; } 
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }
        .interactive { pointer-events: auto; }
        
        .glass-panel { background: rgba(8, 12, 18, 0.95); backdrop-filter: blur(16px); border: 1px solid rgba(0, 243, 255, 0.3); box-shadow: 0 0 40px rgba(0, 243, 255, 0.15); border-radius: 12px; }
        .btn-neon { background: linear-gradient(180deg, rgba(0,243,255,0.1), rgba(0,243,255,0)); border: 1px solid #00f3ff; color: #00f3ff; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; transition: all 0.2s; box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); cursor: pointer; }
        .btn-neon:active { transform: scale(0.95); background: #00f3ff; color: #000; }
        .btn-neon.danger { border-color: #ff0055; color: #ff0055; }
        .btn-disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); cursor: not-allowed; }

        .dice-wrap { perspective: 800px; width: 70px; height: 70px; pointer-events: auto; cursor: pointer; }
        .dice-cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); background: rgba(0,0,0,0.9); border: 2px solid #00f3ff; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 36px; color: #00f3ff; text-shadow: 0 0 15px #00f3ff; }
        .rolling { animation: shake 0.4s infinite; background: #00f3ff; color: #000; text-shadow: none; }
        @keyframes shake { 0%,100% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 75% { transform: rotate(-10deg); } }

        .toast-box { background: #000; border: 1px solid #00f3ff; border-left-width: 5px; padding: 12px 24px; color: white; font-size: 11px; font-family: 'monospace'; transform: translateY(100px); opacity: 0; transition: all 0.4s; }
        .toast-box.show { transform: translateY(0); opacity: 1; }
        #game-toast { background: rgba(8, 12, 18, 0.95); backdrop-filter: blur(8px); border: 1px solid #00f3ff; border-radius: 8px; box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); min-width: 200px; max-width: 90%; padding: 8px 12px; opacity: 0; transform: translateY(-5px); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        #game-toast.show { opacity: 1; transform: translateY(0); }

        #mini-loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; pointer-events: none; }
        #win-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.98); z-index: 60; pointer-events: auto; display: none !important; flex-direction: column; justify-content: center; align-items: center; }
        #win-screen.active { display: flex !important; }

        .opt { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #333; cursor: pointer; transition: 0.2s; transform: scale(0.9); pointer-events: auto; }
        .opt.active { border-color: white; transform: scale(1.2); box-shadow: 0 0 20px currentColor; border-width: 2px; }
        .opt-i { font-size: 24px; color: #555; transition: 0.2s; cursor: pointer; pointer-events: auto; }
        .opt-i.active { color: #00f3ff; transform: scale(1.3); text-shadow: 0 0 15px #00f3ff; }

        #ar-zone button { display: none !important; }

        #btn-rec { display: flex; }
        .ar-sync-btn { background: rgba(0, 0, 0, 0.8) !important; border: 2px solid #ffcc00 !important; color: #ffcc00 !important; font-family: 'Orbitron' !important; padding: 12px 24px !important; border-radius: 8px !important; text-transform: uppercase !important; font-size: 12px; font-weight: bold; box-shadow: 0 0 10px rgba(255, 204, 0, 0.3); }
        .ar-sync-btn:active { transform: scale(0.95); background: #ffcc00 !important; color: #000 !important; }
        
        .btn-end { background: rgba(255, 0, 85, 0.1); border: 1px solid #ff0055; color: #ff0055; font-size: 10px; padding: 8px 12px; border-radius: 8px; font-weight: bold; transition: all 0.2s; }
        .btn-end:active { transform: scale(0.95); background: #ff0055; color: #000; }

        #custom-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; justify-content: center; align-items: center; }
        #modal-content { background: rgba(8, 12, 18, 0.98); backdrop-filter: blur(20px); border: 2px solid #00f3ff; border-radius: 12px; padding: 24px; max-width: 340px; width: 95%; text-align: center; color: white; box-shadow: 0 0 50px rgba(0, 243, 255, 0.3); position: relative; }
        
        #btn-start-ar-float { position: absolute; bottom: 180px; left: 50%; transform: translateX(-50%); z-index: 50; width: auto; white-space: nowrap; }
        
        #ar-instructions { position: absolute; top: 30%; left: 0; width: 100%; text-align: center; pointer-events: none; z-index: 45; display: none; }
        .instr-card { background: rgba(0,0,0,0.6); border: 1px solid #00f3ff; color: #00f3ff; padding: 10px 20px; border-radius: 20px; display: inline-block; backdrop-filter: blur(4px); font-size: 12px; font-weight: bold; box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); }

        #room-label-container { position: absolute; top: 70px; right: 10px; z-index: 10; pointer-events: none; }
        .room-badge { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 2px 6px; font-size: 8px; color: rgba(255,255,255,0.5); font-family: monospace; backdrop-filter: blur(2px); }

        .version-tag { position: absolute; top: 10px; right: 10px; font-family: monospace; font-size: 10px; color: #00f3ff; opacity: 0.7; z-index: 60; pointer-events: none; }

        #s-waiting { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 55; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #s-waiting.active { display: flex; }
        
        #size-slider-container { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); z-index: 40; height: 200px; display: none; flex-direction: column; align-items: center; gap: 10px; pointer-events: auto; }
        #size-slider { -webkit-appearance: none; width: 150px; height: 6px; background: rgba(0, 243, 255, 0.3); border-radius: 3px; outline: none; transform: rotate(-90deg); margin: 70px -70px; }
        #size-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 25px; height: 25px; border-radius: 50%; background: #00f3ff; cursor: pointer; box-shadow: 0 0 10px #00f3ff; border: 2px solid white; }
        .size-icon { color: #00f3ff; font-size: 12px; text-shadow: 0 0 5px #00f3ff; }

        .rank-header { display: flex; justify-content: space-between; padding: 4px 8px; border-bottom: 1px solid #00f3ff; font-size: 9px; color: #00f3ff; font-weight: bold; margin-bottom: 4px; }
        .rank-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 10px; }
        .rank-row:last-child { border-bottom: none; }
        .rank-row.is-me { background: rgba(0, 243, 255, 0.15); border: 1px solid rgba(0, 243, 255, 0.3); border-radius: 4px; }
        .rank-pos { width: 25px; font-weight: bold; text-align: left; }
        .rank-name { flex-grow: 1; text-align: left; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 90px; }
        .rank-stats { width: 50px; text-align: center; color: #aaa; font-family: monospace; font-size: 9px; }
        .rank-pts { width: 50px; text-align: right; font-family: monospace; color: #00f3ff; font-weight: bold; }
        
        .rank-1 .rank-pos { color: #ffd700; text-shadow: 0 0 5px #ffd700; }
        .rank-2 .rank-pos { color: #c0c0c0; }
        .rank-3 .rank-pos { color: #cd7f32; }

        .stat-w { color: #39ff14; }
        .stat-l { color: #ff0055; }
        
        /* Language Picker Styles */
        .lang-btn { position: absolute; top: 10px; left: 10px; z-index: 60; color: #00f3ff; border: 1px solid #00f3ff; padding: 5px 10px; border-radius: 20px; font-size: 10px; background: rgba(0,0,0,0.5); cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .lang-btn:hover { background: rgba(0, 243, 255, 0.2); }
        .lang-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .lang-opt { padding: 10px; border: 1px solid #333; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center; font-size: 12px; }
        .lang-opt:hover { border-color: #00f3ff; color: #00f3ff; background: rgba(0,243,255,0.1); }
        .lang-opt.active { background: #00f3ff; color: black; border-color: #00f3ff; font-weight: bold; }
    </style>

    <script type="importmap">{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/" } }</script>
</head>
<body>
    <canvas id="bg-canvas"></canvas>
    
    <div class="version-tag">V46.2 CONNECT FIX</div>
    
    <!-- Botón de Idioma -->
    <button onclick="window.showLangPicker()" class="lang-btn interactive">
        <i class="fas fa-globe"></i> <span id="cur-lang-code">ES</span>
    </button>

    <div id="ui-layer" class="flex flex-col justify-between p-4 h-full">
        
        <!-- MODAL GENÉRICO -->
        <div id="custom-modal" class="interactive">
            <div id="modal-content">
                <button onclick="document.getElementById('custom-modal').style.display='none'" class="absolute top-2 right-2 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
                <div id="modal-body-content">
                    <!-- CONTENIDO DINÁMICO -->
                </div>
            </div>
        </div>

        <!-- 1. LOGIN -->
        <div id="s-login" class="interactive absolute inset-0 flex items-center justify-center bg-black/95 z-50">
            <div class="glass-panel p-8 text-center w-full max-w-xs flex flex-col items-center gap-6">
                <div class="text-6xl text-cyber animate-pulse-fast"><i class="fas fa-globe-network"></i></div>
                <div>
                    <h1 class="text-4xl font-black text-white italic tracking-tighter">3 LINE<span class="text-cyber">-AR</span></h1>
                    <p class="text-gray-500 text-[9px] font-mono tracking-[0.4em] mt-2">V46.2</p>
                </div>
                <button id="btn-login-google" onclick="window.doLogin()" class="btn-neon w-full py-4 flex justify-center items-center gap-3 text-sm hover:bg-cyber/10">
                    <i class="fab fa-google"></i> <span id="login-btn-txt" data-i18n="login">INICIAR SESIÓN</span>
                </button>
                
                <button onclick="window.doGuestLogin()" class="text-[10px] text-gray-500 underline hover:text-white" data-i18n="guest_login">Jugar como Invitado</button>
                
                <p id="login-msg" class="text-[9px] text-gray-600 hidden" data-i18n="connecting">CONECTANDO...</p>
                <button id="btn-cancel-login" onclick="window.cancelLogin()" class="hidden btn-neon danger py-1 px-3 text-[9px]" data-i18n="cancel">CANCELAR</button>
            </div>
        </div>

        <!-- 2. MENU -->
        <div id="s-menu" class="interactive absolute inset-0 flex items-center justify-center bg-black/90 z-40 hidden">
            <div class="glass-panel p-6 w-full max-w-xs flex flex-col gap-4 relative">
                
                <div class="flex justify-between items-center border-b border-white/10 pb-3">
                    <div class="flex items-center gap-2">
                        <img id="u-photo" src="" class="w-8 h-8 rounded-full border border-cyber hidden">
                        <div><span class="text-[9px] text-cyber block tracking-widest" data-i18n="agent">AGENTE</span><span id="u-name" class="text-white font-bold text-lg">...</span></div>
                    </div>
                    <button onclick="window.confirmLogout()" class="w-8 h-8 rounded border border-danger text-danger flex items-center justify-center hover:bg-danger hover:text-white transition"><i class="fas fa-power-off"></i></button>
                </div>

                <div class="bg-white/5 p-4 rounded border border-white/10 pointer-events-auto">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[9px] text-gray-400 font-bold" data-i18n="color">COLOR</span>
                        <div class="flex gap-3" id="c-pick">
                            <div onclick="window.setProf('c','#00f3ff',this)" class="opt bg-[#00f3ff] active" style="box-shadow:0 0 15px #00f3ff"></div>
                            <div onclick="window.setProf('c','#ff0055',this)" class="opt bg-[#ff0055]"></div>
                            <div onclick="window.setProf('c','#39ff14',this)" class="opt bg-[#39ff14]"></div>
                            <div onclick="window.setProf('c','#ffd700',this)" class="opt bg-[#ffd700]"></div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[9px] text-gray-400 font-bold" data-i18n="mark">MARCA</span>
                        <div class="flex gap-4 text-lg" id="i-pick">
                            <i onclick="window.setProf('i','gem',this)" class="opt-i fas fa-gem active"></i>
                            <i onclick="window.setProf('i','bolt',this)" class="opt-i fas fa-bolt"></i>
                            <i onclick="window.setProf('i','star',this)" class="opt-i fas fa-star"></i>
                            <i onclick="window.setProf('i','atom',this)" class="opt-i fas fa-atom"></i>
                        </div>
                    </div>
                </div>

                <button id="btn-quick-match" onclick="window.quickMatch()" class="btn-neon btn-disabled py-5 text-lg shadow-lg relative overflow-hidden group">
                    <span class="relative z-10"><i class="fas fa-globe mr-2"></i> <span data-i18n="quick_match">PARTIDA PÚBLICA</span></span>
                    <div class="absolute inset-0 bg-cyber/20 transform -translate-x-full group-hover:translate-x-0 transition-transform duration-300"></div>
                </button>
                
                <div class="grid grid-cols-2 gap-3">
                    <button id="btn-create-room" onclick="window.createRoom()" class="btn-neon btn-disabled py-3 text-xs" data-i18n="create_room">CREAR SALA</button>
                    <button id="btn-join-room" onclick="window.showJoin()" class="btn-neon btn-disabled py-3 text-xs" data-i18n="join_room">UNIRSE</button>
                </div>
                
                <div id="join-box" class="hidden flex gap-2 mt-1 animate-fade-in">
                    <input id="code-in" class="bg-black/50 border border-cyber text-white w-full text-center p-3 uppercase font-mono text-lg tracking-widest" placeholder="CODE" maxlength="4">
                    <button onclick="window.joinRoom()" class="btn-neon w-14"><i class="fas fa-arrow-right"></i></button>
                </div>
                
                <div class="flex gap-2 mt-2">
                    <button id="btn-vs-cpu" onclick="window.vsCpu()" class="btn-neon danger btn-disabled py-3 text-xs flex-1"><i class="fas fa-microchip mr-2"></i> <span data-i18n="vs_cpu">VS CPU</span></button>
                    <button onclick="window.systemToast('INFO', 'Próximamente')" class="btn-neon flex-1 py-3 text-xs border-gray-600 text-gray-500 opacity-50 cursor-not-allowed"><i class="fas fa-share-nodes mr-2"></i> <span data-i18n="invite">INVITAR</span></button>
                </div>

                <button onclick="window.showLeaderboard()" class="btn-neon mt-2 py-3 text-xs border-yellow-500 text-yellow-400 shadow-[0_0_10px_rgba(255,215,0,0.2)]"><i class="fas fa-trophy mr-2"></i> <span data-i18n="ranking">RANKING</span></button>

                <div id="ar-status" class="text-center mt-1 text-[9px] text-gray-500 font-mono" data-i18n="check_hw">VERIFICANDO HARDWARE...</div>
            </div>
        </div>

        <!-- PANTALLA DE CARGA MATCHMAKING -->
        <div id="s-matchmaking" class="interactive absolute inset-0 flex items-center justify-center bg-black/95 z-50 hidden">
            <div class="text-center">
                <div class="relative w-24 h-24 mx-auto mb-6">
                    <div class="absolute inset-0 border-4 border-cyber/30 rounded-full animate-ping"></div>
                    <div class="absolute inset-0 border-4 border-t-cyber border-r-transparent border-b-cyber border-l-transparent rounded-full animate-spin"></div>
                    <i class="fas fa-globe text-4xl text-cyber absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></i>
                </div>
                <h2 class="text-2xl font-black text-white italic" id="match-status-title" data-i18n="searching">BUSCANDO RIVAL</h2>
                <p class="text-cyber font-mono text-xs tracking-widest mt-2 animate-pulse" id="match-status-desc" data-i18n="scanning">ESCANEANDO RED...</p>
                <button onclick="window.cancelMatchmaking()" class="mt-8 btn-neon danger py-2 px-6 text-xs" data-i18n="cancel">CANCELAR</button>
            </div>
        </div>

        <!-- PANTALLA DE ESPERA PRIVADA -->
        <div id="s-waiting" class="interactive">
            <div class="glass-panel p-8 text-center w-full max-w-xs flex flex-col items-center gap-6 relative">
                <div class="absolute top-4 right-4 cursor-pointer text-gray-500 hover:text-white" onclick="window.goHome()"><i class="fas fa-times"></i></div>
                <h2 class="text-xl font-bold text-white" data-i18n="private_room">SALA PRIVADA</h2>
                <div class="text-sm text-gray-400" data-i18n="share_code">COMPARTE CÓDIGO:</div>
                <div id="waiting-code" class="text-5xl font-black text-cyber tracking-widest border-2 border-dashed border-cyber/50 p-4 rounded-lg bg-black/50 select-all">----</div>
                <div class="flex items-center gap-2 mt-2">
                    <div class="w-2 h-2 rounded-full bg-neon animate-pulse"></div>
                    <span class="text-[10px] text-neon font-mono" data-i18n="waiting_player">ESPERANDO JUGADOR...</span>
                </div>
            </div>
        </div>

        <!-- 3. GAME HUD -->
        <div id="s-game" class="hidden flex flex-col justify-between h-full pointer-events-none relative z-10">
            <!-- SLIDER DE TAMAÑO -->
            <div id="size-slider-container">
                <i class="fas fa-plus size-icon"></i>
                <input type="range" id="size-slider" min="0.1" max="3" step="0.1" value="1" oninput="window.manualScale(this.value)">
                <i class="fas fa-minus size-icon"></i>
            </div>

            <!-- BOTÓN SALIR AR -->
            <div id="btn-exit-ar" class="hidden interactive absolute top-4 left-4 z-50">
                <button onclick="window.goHome()" class="bg-red-600/90 text-white border border-red-400 font-bold py-2 px-4 rounded-lg shadow-lg text-xs backdrop-blur"><i class="fas fa-times mr-2"></i> <span data-i18n="exit_ar">SALIR AR</span></button>
            </div>

            <div class="interactive glass-panel p-3 flex justify-between items-start mt-8 mx-2 backdrop-blur-md">
                <div class="text-center w-20">
                    <span class="text-[8px] text-gray-400 block tracking-widest" data-i18n="score">PUNTAJE</span>
                    <span id="sc-p1" class="text-3xl text-white font-black leading-none">0</span>
                </div>
                <div class="flex flex-col items-center -mt-10 z-20">
                    <div class="dice-wrap" onclick="window.rollDice()"><div id="dice-vis" class="dice-cube"><i class="fas fa-dice-d20"></i></div></div>
                    <div id="game-toast" class="text-center mt-2 interactive">
                        <p id="t-head" class="font-bold text-cyber text-xs mb-1 border-b border-white/10 pb-1 uppercase tracking-widest">3 LINE-AR</p>
                        <p id="t-body" class="text-sm tracking-wide">Mensaje</p>
                    </div>
                    <div id="mov-hud" class="bg-black/90 px-3 py-1 mt-3 rounded border border-cyber text-center opacity-0 transition-opacity min-w-[120px] shadow-lg flex items-center justify-between gap-2">
                        <div><p class="text-[7px] text-gray-400 tracking-widest" data-i18n="lines">LÍNEAS</p><p id="mov-cnt" class="text-xl text-cyber font-bold leading-none">0</p></div>
                        <button onclick="window.skipTurn()" class="text-[8px] text-red-500 border border-red-500 px-2 py-1 rounded hover:bg-red-500 hover:text-white transition font-bold leading-tight" data-i18n="skip">SIN<br>JUGADAS</button>
                    </div>
                </div>
                <div class="text-center w-20">
                    <span class="text-[8px] text-gray-400 block tracking-widest" data-i18n="rival">RIVAL</span>
                    <span id="sc-p2" class="text-3xl text-white font-black leading-none">0</span>
                </div>
            </div>
            
            <div id="room-label-container" class="pointer-events-none">
                 <span class="room-badge">ID: <span id="room-lbl">--</span></span>
            </div>

            <div id="mini-loader" class="hidden text-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyber mx-auto mb-2"></div><span id="mini-load-txt" class="bg-black/80 text-cyber text-[10px] px-2 py-1 rounded border border-cyber" data-i18n="loading">CARGANDO...</span></div>

            <div id="ar-instructions">
                <div class="instr-card" id="ar-instr-txt"></div>
            </div>

            <div class="flex justify-center items-center flex-grow pointer-events-none absolute bottom-1/2 left-1/2 -translate-x-1/2 translate-y-1/2">
                <div id="toast" class="toast-box text-center"><p id="s-head" class="font-bold text-cyber text-xs mb-1 border-b border-white/10 pb-1 uppercase tracking-widest">3 LINE-AR</p><p id="s-body" class="text-sm tracking-wide">Mensaje</p></div>
            </div>

            <div class="interactive flex justify-center gap-6 pb-24 md:pb-10 items-end w-full px-4" id="pc-controls">
                <button onclick="window.confirmFinishGame()" class="btn-end flex items-center gap-1"><i class="fas fa-flag-checkered"></i> <span data-i18n="surrender">RENDIRSE</span></button>
                <button onclick="window.goHome()" class="w-14 h-14 rounded-full bg-gray-800/90 border border-gray-600 text-gray-300 flex flex-col items-center justify-center shadow-lg hover:border-white hover:text-white transition z-50"><i class="fas fa-home text-lg"></i><span class="text-[8px] font-bold mt-1" data-i18n="home">INICIO</span></button>
                <button onclick="window.recenter()" id="btn-rec" class="px-6 h-12 rounded-full bg-cyber/10 border border-cyber text-cyber text-xs font-mono shadow-[0_0_15px_rgba(0,243,255,0.2)] hover:bg-cyber/30 hover:text-white transition flex items-center gap-2"><i class="fas fa-compress-arrows-alt"></i> <span data-i18n="recenter">RE-CENTRAR</span></button>
            </div>
            
            <div id="btn-start-ar-float" class="hidden interactive">
                <button onclick="window.startARSession()" class="btn-neon py-3 px-6 text-xs shadow-[0_0_20px_#00f3ff] animate-bounce bg-black/80"><i class="fas fa-cube mr-2"></i> <span data-i18n="start_ar">INICIAR MODO AR</span></button>
            </div>
            
            <div id="ar-controls" class="interactive absolute bottom-6 left-1/2 -translate-x-1/2 hidden justify-center gap-4 z-40 w-full px-4">
                <button onclick="window.acceptScaleAndPosition()" id="btn-ar-accept" class="ar-sync-btn flex-1"><i class="fas fa-check mr-2"></i> <span data-i18n="fix">FIJAR</span></button>
                <button onclick="window.recalibrate()" id="btn-ar-recal" class="ar-sync-btn flex-1 bg-gray-800/80 border-gray-500 !text-gray-200"><i class="fas fa-sync-alt mr-2"></i> <span data-i18n="move">MOVER</span></button>
            </div>
        </div>

        <!-- WIN SCREEN -->
        <div id="win-screen">
            <h1 id="win-title" class="text-4xl md:text-6xl font-black text-cyber mb-2 animate-pulse text-center px-4" data-i18n="victory">VICTORIA</h1>
            <p id="win-msg" class="text-white font-mono mb-2 tracking-widest text-center text-sm px-4">MENSAJE MOTIVACIONAL</p>
            <p id="elo-change" class="text-neon font-bold text-lg mb-6 animate-bounce">+0 PUNTOS</p>
            
            <div class="glass-panel p-6 mb-8 w-full max-w-sm mx-4">
                <div class="flex justify-between items-center text-center">
                    <div><span class="text-gray-500 text-[10px] block tracking-widest mb-1" data-i18n="score">TU PUNTAJE</span><span id="final-p1" class="text-5xl font-bold text-white">0</span></div>
                    <div class="h-10 w-px bg-white/20"></div>
                    <div><span class="text-gray-500 text-[10px] block tracking-widest mb-1" data-i18n="rival">RIVAL</span><span id="final-p2" class="text-5xl font-bold text-white">0</span></div>
                </div>
            </div>
            <div class="flex flex-col gap-3 w-full max-w-xs px-4">
                <button onclick="window.goHomeAfterWin()" class="btn-neon py-3 px-6 text-sm w-full"><i class="fas fa-bars mr-2"></i> <span data-i18n="back_menu">VOLVER AL MENÚ</span></button>
            </div>
        </div>
    </div>

    <div id="ar-zone"></div>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, onSnapshot, getDoc, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, signInAnonymously, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithCustomToken, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- SISTEMA DE TRADUCCIÓN (I18N) ---
        const TR = {
            es: {
                login: "INICIAR SESIÓN", guest_login: "Jugar como Invitado", connecting: "CONECTANDO...", cancel: "CANCELAR",
                agent: "AGENTE", color: "COLOR", mark: "MARCA", quick_match: "PARTIDA PÚBLICA", create_room: "CREAR SALA",
                join_room: "UNIRSE", vs_cpu: "VS CPU", invite: "INVITAR", ranking: "RANKING", check_hw: "VERIFICANDO HARDWARE...",
                searching: "BUSCANDO RIVAL", scanning: "ESCANEANDO RED...", private_room: "SALA PRIVADA", share_code: "COMPARTE CÓDIGO:",
                waiting_player: "ESPERANDO JUGADOR...", exit_ar: "SALIR AR", score: "PUNTAJE", lines: "LÍNEAS", skip: "SIN JUGADAS",
                rival: "RIVAL", loading: "CARGANDO...", surrender: "RENDIRSE", home: "INICIO", recenter: "RE-CENTRAR",
                start_ar: "INICIAR MODO AR", fix: "FIJAR", move: "MOVER", victory: "VICTORIA", defeat: "DERROTA", draw: "EMPATE",
                back_menu: "VOLVER AL MENÚ", wait_turn: "Turno Rival", play_turn: "Usa tus líneas", roll_dice: "Lanza el dado",
                energy: "ENERGÍA", pass: "PASO", turn_skipped: "Turno cedido", error: "ERROR", login_req: "Login requerido",
                room_full: "Sala llena", ar_scan: "MODO ESCANEO", ar_tap_fix: "Toca para fijar", ar_floor: "PISO DETECTADO",
                ar_air: "MODO AÉREO", ar_adjust: "AJUSTANDO...", ar_sync: "OK", ar_sync_msg: "Tablero sincronizado.",
                pts: "PTS", win_msg: "DOMINIO TOTAL", lose_msg: "BUEN INTENTO", draw_msg: "EQUILIBRIO",
                blocked: "BLOQUEADO", range: "RANGO", occupied: "OCUPADO", conquest: "¡Nexo Cerrado!", link: "Enlace establecido"
            },
            en: {
                login: "LOGIN", guest_login: "Play as Guest", connecting: "CONNECTING...", cancel: "CANCEL",
                agent: "AGENT", color: "COLOR", mark: "MARK", quick_match: "QUICK MATCH", create_room: "CREATE ROOM",
                join_room: "JOIN ROOM", vs_cpu: "VS CPU", invite: "INVITE", ranking: "RANKING", check_hw: "CHECKING HARDWARE...",
                searching: "SEARCHING RIVAL", scanning: "SCANNING NETWORK...", private_room: "PRIVATE ROOM", share_code: "SHARE CODE:",
                waiting_player: "WAITING PLAYER...", exit_ar: "EXIT AR", score: "SCORE", lines: "LINES", skip: "SKIP TURN",
                rival: "RIVAL", loading: "LOADING...", surrender: "GIVE UP", home: "HOME", recenter: "RE-CENTER",
                start_ar: "START AR MODE", fix: "PLACE", move: "MOVE", victory: "VICTORY", defeat: "DEFEAT", draw: "DRAW",
                back_menu: "BACK TO MENU", wait_turn: "Opponent's Turn", play_turn: "Your Turn", roll_dice: "Roll Dice",
                energy: "ENERGY", pass: "PASS", turn_skipped: "Turn Skipped", error: "ERROR", login_req: "Login Required",
                room_full: "Room Full", ar_scan: "SCAN MODE", ar_tap_fix: "Tap to Place", ar_floor: "FLOOR DETECTED",
                ar_air: "AIR MODE", ar_adjust: "ADJUSTING...", ar_sync: "OK", ar_sync_msg: "Board Synced.",
                pts: "PTS", win_msg: "TOTAL DOMINATION", lose_msg: "NICE TRY", draw_msg: "BALANCE",
                blocked: "BLOCKED", range: "RANGE", occupied: "OCCUPIED", conquest: "Nexus Closed!", link: "Link Established"
            },
            zh: {
                login: "登录", guest_login: "游客模式", connecting: "连接中...", cancel: "取消",
                agent: "特工", color: "颜色", mark: "标志", quick_match: "快速匹配", create_room: "创建房间",
                join_room: "加入房间", vs_cpu: "人机对战", invite: "邀请", ranking: "排行榜", check_hw: "检查硬件...",
                searching: "寻找对手", scanning: "扫描网络...", private_room: "私人房间", share_code: "分享代码:",
                waiting_player: "等待玩家...", exit_ar: "退出AR", score: "得分", lines: "线条", skip: "跳过",
                rival: "对手", loading: "加载中...", surrender: "投降", home: "主页", recenter: "重置",
                start_ar: "启动AR", fix: "放置", move: "移动", victory: "胜利", defeat: "失败", draw: "平局",
                back_menu: "返回菜单", wait_turn: "对手回合", play_turn: "你的回合", roll_dice: "掷骰子",
                energy: "能量", pass: "跳过", turn_skipped: "回合跳过", error: "错误", login_req: "需要登录",
                room_full: "房间已满", ar_scan: "扫描模式", ar_tap_fix: "点击放置", ar_floor: "检测到地面",
                ar_air: "空中模式", ar_adjust: "调整中...", ar_sync: "好", ar_sync_msg: "棋盘同步",
                pts: "分", win_msg: "完全统治", lose_msg: "再接再厉", draw_msg: "势均力敌",
                blocked: "受阻", range: "范围", occupied: "已占", conquest: "连接完成!", link: "链接建立"
            },
            fr: {
                login: "CONNEXION", guest_login: "Mode Invité", connecting: "CONNEXION...", cancel: "ANNULER",
                agent: "AGENT", color: "COULEUR", mark: "MARQUE", quick_match: "PARTIE RAPIDE", create_room: "CRÉER SALLE",
                join_room: "REJOINDRE", vs_cpu: "VS CPU", invite: "INVITER", ranking: "CLASSEMENT", check_hw: "VÉRIFICATION...",
                searching: "RECHERCHE...", scanning: "SCAN RÉSEAU...", private_room: "SALLE PRIVÉE", share_code: "CODE:",
                waiting_player: "EN ATTENTE...", exit_ar: "QUITTER AR", score: "SCORE", lines: "LIGNES", skip: "PASSER",
                rival: "RIVAL", loading: "CHARGEMENT...", surrender: "ABANDON", home: "ACCUEIL", recenter: "RECENTRER",
                start_ar: "MODE AR", fix: "PLACER", move: "BOUGER", victory: "VICTOIRE", defeat: "DÉFAITE", draw: "ÉGALITÉ",
                back_menu: "MENU", wait_turn: "Tour Adverse", play_turn: "À vous", roll_dice: "Lancer Dé",
                energy: "ÉNERGIE", pass: "PASSE", turn_skipped: "Tour passé", error: "ERREUR", login_req: "Connexion requise",
                room_full: "Complet", ar_scan: "SCAN", ar_tap_fix: "Toucher pour placer", ar_floor: "SOL DÉTECTÉ",
                ar_air: "MODE AÉRIEN", ar_adjust: "AJUSTEMENT...", ar_sync: "OK", ar_sync_msg: "Sync. Terminée",
                pts: "PTS", win_msg: "DOMINATION", lose_msg: "BIEN ESSAYÉ", draw_msg: "ÉQUILIBRE",
                blocked: "BLOQUÉ", range: "DISTANCE", occupied: "OCCUPÉ", conquest: "Nexus Fermé!", link: "Lien Établi"
            },
            de: {
                login: "ANMELDEN", guest_login: "Als Gast", connecting: "VERBINDEN...", cancel: "ABBRECHEN",
                agent: "AGENT", color: "FARBE", mark: "ZEICHEN", quick_match: "SCHNELLES SPIEL", create_room: "RAUM ERSTELLEN",
                join_room: "BEITRETEN", vs_cpu: "GEGEN CPU", invite: "EINLADEN", ranking: "RANGLISTE", check_hw: "PRÜFUNG...",
                searching: "SUCHE GEGNER", scanning: "SCANNE...", private_room: "PRIVATRAUM", share_code: "CODE TEILEN:",
                waiting_player: "WARTE...", exit_ar: "AR BEENDEN", score: "PUNKTE", lines: "LINIEN", skip: "ÜBERSPRINGEN",
                rival: "GEGNER", loading: "LADEN...", surrender: "AUFGEBEN", home: "HOME", recenter: "ZENTRIEREN",
                start_ar: "AR STARTEN", fix: "PLATZIEREN", move: "BEWEGEN", victory: "SIEG", defeat: "NIEDERLAGE", draw: "UNENTSCHIEDEN",
                back_menu: "HAUPTMENÜ", wait_turn: "Gegnerzug", play_turn: "Dein Zug", roll_dice: "Würfeln",
                energy: "ENERGIE", pass: "PASSEN", turn_skipped: "Zug übersprungen", error: "FEHLER", login_req: "Login nötig",
                room_full: "Raum voll", ar_scan: "SCAN-MODUS", ar_tap_fix: "Tippen zum Platzieren", ar_floor: "BODEN ERKANNT",
                ar_air: "LUFT-MODUS", ar_adjust: "ANPASSEN...", ar_sync: "OK", ar_sync_msg: "Synchronisiert",
                pts: "PKT", win_msg: "DOMINATION", lose_msg: "GUTER VERSUCH", draw_msg: "BALANCE",
                blocked: "BLOCKIERT", range: "REICHWEITE", occupied: "BESETZT", conquest: "Nexus Geschlossen!", link: "Verbunden"
            },
            ru: {
                login: "ВОЙТИ", guest_login: "Гостевой режим", connecting: "ПОДКЛЮЧЕНИЕ...", cancel: "ОТМЕНА",
                agent: "АГЕНТ", color: "ЦВЕТ", mark: "ЗНАК", quick_match: "БЫСТРАЯ ИГРА", create_room: "СОЗДАТЬ",
                join_room: "ВОЙТИ", vs_cpu: "ПРОТИВ CPU", invite: "ПРИГЛАСИТЬ", ranking: "РЕЙТИНГ", check_hw: "ПРОВЕРКА...",
                searching: "ПОИСК...", scanning: "СКАНИРОВАНИЕ...", private_room: "ПРИВАТНАЯ", share_code: "КОД:",
                waiting_player: "ОЖИДАНИЕ...", exit_ar: "ВЫХОД AR", score: "СЧЕТ", lines: "ЛИНИИ", skip: "ПРОПУСК",
                rival: "СОПЕРНИК", loading: "ЗАГРУЗКА...", surrender: "СДАТЬСЯ", home: "ДОМОЙ", recenter: "ЦЕНТР",
                start_ar: "СТАРТ AR", fix: "СТАВИТЬ", move: "ДВИГАТЬ", victory: "ПОБЕДА", defeat: "ПОРАЖЕНИЕ", draw: "НИЧЬЯ",
                back_menu: "МЕНЮ", wait_turn: "Ход соперника", play_turn: "Твой ход", roll_dice: "Бросить куб",
                energy: "ЭНЕРГИЯ", pass: "ПАС", turn_skipped: "Пропуск хода", error: "ОШИБКА", login_req: "Нужен вход",
                room_full: "Мест нет", ar_scan: "СКАНИРОВАНИЕ", ar_tap_fix: "Нажми чтобы поставить", ar_floor: "ПОЛ НАЙДЕН",
                ar_air: "РЕЖИМ ВОЗДУХА", ar_adjust: "НАСТРОЙКА...", ar_sync: "ОК", ar_sync_msg: "Синхронизация",
                pts: "ОЧК", win_msg: "ДОМИНИРОВАНИЕ", lose_msg: "ХОРОШАЯ ПОПЫТКА", draw_msg: "БАЛАНС",
                blocked: "БЛОК", range: "ДАЛЕКО", occupied: "ЗАНЯТО", conquest: "Связь создана!", link: "Соединено"
            }
        };

        const manualConfig = { apiKey: "AIzaSyBbPYnUPaO-kzWWStS8013SOvdTSuK3KP4", authDomain: "ar-3lilne.firebaseapp.com", projectId: "ar-3lilne", appId: "1:382966716480:web:ee244825bb34bc35c667a5" };
        const firebaseConfig = (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : manualConfig);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-ar-app';
        
        let app, auth, db;
        try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); if (typeof __initial_auth_token !== 'undefined') { signInWithCustomToken(auth, __initial_auth_token); } } 
        catch(e) { console.error("Firebase Init Fail", e); }

        const LOSE_MSGS = ["¡CASI LO TIENES!", "INTENTA DE NUEVO", "LA PRÓXIMA SERÁ TUYA", "BUEN INTENTO"];
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if(type === 'click') { osc.type='sine'; osc.frequency.setValueAtTime(800,now); osc.frequency.exponentialRampToValueAtTime(300,now+0.1); gain.gain.setValueAtTime(0.1,now); gain.gain.exponentialRampToValueAtTime(0.01,now+0.1); osc.start(now); osc.stop(now+0.1); } 
            else if(type === 'win') { osc.type='triangle'; osc.frequency.setValueAtTime(400,now); osc.frequency.linearRampToValueAtTime(800,now+0.2); gain.gain.setValueAtTime(0.1,now); gain.gain.linearRampToValueAtTime(0,now+0.3); osc.start(now); osc.stop(now+0.3); } 
            else if(type === 'roll') { osc.type='square'; osc.frequency.setValueAtTime(100,now); gain.gain.setValueAtTime(0.05,now); gain.gain.exponentialRampToValueAtTime(0.01,now+0.15); osc.start(now); osc.stop(0.15); } 
        }

        let S = { user:null, room:null, role:null, cpu:false, data:null, prof:{c:'#00f3ff', i:'gem'}, points: 1000, wins: 0, losses: 0, lang: 'es' };
        let pts=[], selPt=null, placed=false, roomUnsub=null, currentScale=0.1; 
        let arInitialized = false, isArHost = false, placementAccepted = false; 
        let scene, cam, ren, group, ray, reticle, arHit, controls, arRefSpace, arBtn, ghostGroup;
        let isMatchmaking = false;
        let heartbeatInterval = null; // --- FIX: VARIABLE PARA EL LATIDO DEL HOST ---
        
        // --- GESTIÓN DE IDIOMA ---
        window.detectLanguage = () => {
            const l = navigator.language || navigator.userLanguage;
            const code = l.split('-')[0].toLowerCase();
            return (TR[code]) ? code : 'en'; 
        }

        window.setLanguage = (lang) => {
            S.lang = lang;
            document.getElementById('cur-lang-code').innerText = lang.toUpperCase();
            document.body.classList.remove('lang-zh', 'lang-ru');
            if(lang === 'zh') document.body.classList.add('lang-zh');
            if(lang === 'ru') document.body.classList.add('lang-ru');
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(TR[lang][key]) el.innerText = TR[lang][key];
            });
            document.getElementById('custom-modal').style.display='none';
        }

        window.t = (key) => TR[S.lang][key] || key;

        window.showLangPicker = () => {
            const opts = Object.keys(TR).map(k => 
                `<div class="lang-opt ${S.lang===k?'active':''}" onclick="window.setLanguage('${k}')">${k.toUpperCase()}</div>`
            ).join('');
            window.showModal(`
                <h3 class="text-lg font-bold text-cyber mb-3">IDIOMA / LANGUAGE</h3>
                <div class="lang-grid">${opts}</div>
            `);
        }

        function nav(id) {
            ['s-login','s-menu','s-game','s-waiting','win-screen','s-matchmaking'].forEach(i => { const el = document.getElementById(i); if (el) { el.classList.add('hidden'); if(i === 'win-screen') el.classList.remove('active'); if(i==='s-waiting') el.classList.remove('active');} });
            const target = document.getElementById(id); if (target) { target.classList.remove('hidden'); if(id === 'win-screen' || id === 's-waiting') target.classList.add('active'); }
        }

        if (auth) {
            onAuthStateChanged(auth, async (u) => {
                if(u) {
                    S.user = u; document.getElementById('login-btn-txt').innerText = t('connecting');
                    try { await registerUserAccess(u); } catch(e) {}
                    if (!document.getElementById('s-login').classList.contains('hidden')) {
                        const uName = document.getElementById('u-name'); if(uName) uName.innerText = u.displayName ? u.displayName.split(' ')[0].toUpperCase() : (u.isAnonymous ? "INVITADO" : u.uid.substring(0,8).toUpperCase()); 
                        nav('s-menu'); 
                    }
                    window.checkAR(); 
                    setTimeout(() => window.updateMenuButtons(true), 500);
                } else {
                    S.user = null; nav('s-login'); document.getElementById('login-btn-txt').innerText = t('login'); window.updateMenuButtons(false);
                }
            });
        }
        
        window.setLanguage(window.detectLanguage());

        async function registerUserAccess(u) { 
            const userRef = doc(db, 'artifacts', appId, 'users', u.uid); 
            const snap = await getDoc(userRef);
            let currentPoints = 1000; let currentWins = 0; let currentLosses = 0;
            if(snap.exists()) {
                const data = snap.data();
                currentPoints = data.points || 1000; currentWins = data.wins || 0; currentLosses = data.losses || 0;
                await updateDoc(userRef, { lastLogin: Date.now() });
            } else {
                await setDoc(userRef, { uid: u.uid, lastLogin: Date.now(), displayName: u.displayName || 'Anon', status: 'online', points: 1000, wins:0, losses:0 }, { merge: true });
            }
            S.points = currentPoints; S.wins = currentWins; S.losses = currentLosses;
        }
        
        window.updateMenuButtons = (enabled) => { 
            ['btn-quick-match', 'btn-create-room', 'btn-join-room', 'btn-vs-cpu'].forEach(id => { 
                const btn = document.getElementById(id); 
                if (btn) { 
                    if(enabled) btn.classList.remove('btn-disabled'); 
                    else btn.classList.add('btn-disabled'); 
                } 
            }); 
        };
        
        let loginTimeout;
        window.doLogin = async () => { 
            if(!auth) return; 
            const btn = document.getElementById('btn-login-google');
            const txt = document.getElementById('login-btn-txt');
            const msg = document.getElementById('login-msg');
            const cancelBtn = document.getElementById('btn-cancel-login');
            
            btn.classList.add('btn-disabled');
            txt.innerText = t('connecting');
            msg.classList.remove('hidden');
            cancelBtn.classList.remove('hidden');

            loginTimeout = setTimeout(() => {
                msg.innerText = "TIMEOUT...";
                btn.classList.remove('btn-disabled');
                txt.innerText = "RETRY";
            }, 8000);
            
            try{ 
                const provider = new GoogleAuthProvider();
                provider.setCustomParameters({ prompt: 'select_account' });
                await setPersistence(auth, browserLocalPersistence); 
                await signInWithPopup(auth, provider); 
                clearTimeout(loginTimeout);
            } catch(e) { 
                console.error("Login Error:", e);
                window.cancelLogin();
                window.systemToast("INFO", "Guest Mode"); 
            } 
        };

        window.doGuestLogin = async () => { if(!auth) return; try { await signInAnonymously(auth); } catch(e) { window.systemToast("ERROR", "Guest Failed"); } };

        window.cancelLogin = () => {
             clearTimeout(loginTimeout);
             const btn = document.getElementById('btn-login-google');
             if(btn) btn.classList.remove('btn-disabled');
             document.getElementById('login-btn-txt').innerText = t('login');
             document.getElementById('login-msg').classList.add('hidden');
             document.getElementById('btn-cancel-login').classList.add('hidden');
        };

        window.startARSession = () => { if(arBtn) arBtn.click(); }

        window.doPlace = () => {
            if (ren.xr.isPresenting && isArHost && !placed) {
                placed = true; reticle.visible = false;
                group.position.setFromMatrixPosition(reticle.matrix); 
                group.rotation.setFromRotationMatrix(reticle.matrix);
                if(reticle.matrixAutoUpdate) { group.position.copy(reticle.position); group.rotation.copy(reticle.rotation); }
                group.visible = true;
                if(ghostGroup) ghostGroup.visible = false;
                document.getElementById('ar-instructions').style.display='none';
                showArControls();
                window.gameToast(t('ar_sync'), t('ar_tap_fix'));
            }
        }

        function genPoints() {
            const p=[]; for(let i=0;i<16;i++){ let v=false, pt, att=0; while(!v && att<100){ pt = { x:(Math.random()-0.5)*1.8, y:0, z:(Math.random()-0.5)*1.8 }; let ok=true; for(let ex of p) if(Math.hypot(ex.x-pt.x, ex.z-pt.z) < 0.35) ok=false; if(ok) v=true; att++; } p.push(pt); } return p;
        }

        window.intersect = (a, b) => Math.hypot(a.x - b.x, a.z - b.z) < 0.25;
        window.isPointInTriangle = (p, a, b, c) => {
            const area = 0.5 * (-b.z * c.x + a.z * (-b.x + c.x) + a.x * (b.z - c.z) + b.x * c.z);
            const sign = area < 0 ? -1 : 1;
            const s = (a.z * c.x - a.x * c.z + (c.z - a.z) * p.x + (a.x - c.x) * p.z) * sign;
            const t = (a.x * b.z - a.z * b.x + (a.z - b.z) * p.x + (b.x - a.x) * p.z) * sign;
            return s > 0.001 && t > 0.001 && (s + t) < 2 * area * sign - 0.001;
        }

        window.buildBoard = () => {
            if(!S.data || !S.data.points || !group) return;
            while(group.children.length > 0) group.remove(group.children[0]);
            if(ghostGroup) { while(ghostGroup.children.length > 0) ghostGroup.remove(ghostGroup.children[0]); } else if(scene) { ghostGroup = new THREE.Group(); scene.add(ghostGroup); }

            pts = [];
            const geo=new THREE.SphereGeometry(0.05,32,32); 
            const mat=new THREE.MeshStandardMaterial({color:0x111111, emissive:0x00f3ff, emissiveIntensity:1.5}); 
            const ghostMat = new THREE.MeshBasicMaterial({color: 0x00f3ff, transparent: true, opacity: 0.5, wireframe: false}); 

            S.data.points.forEach((p,i)=>{
                const m=new THREE.Mesh(geo,mat.clone()); m.position.set(p.x,p.y,p.z); m.userData.id=i;
                m.add(new THREE.Mesh(new THREE.SphereGeometry(0.12), new THREE.MeshBasicMaterial({visible:false}))); 
                group.add(m); pts.push(m);
                if(ghostGroup) { const gm = new THREE.Mesh(geo, ghostMat); gm.position.set(p.x, p.y, p.z); ghostGroup.add(gm); }
            });
            window.draw();
            if (ren && !ren.xr.isPresenting) { group.visible = true; placed = true; window.recenter(); if(ghostGroup) ghostGroup.visible = false; } 
            else { currentScale = 0.2; group.scale.set(0.2, 0.2, 0.2); if(ghostGroup) { ghostGroup.scale.set(0.2, 0.2, 0.2); ghostGroup.visible = false; } }
        }

        window.rollDice = () => {
            const d=S.data; if(d.turn!==S.role) return window.gameToast("✋", t('wait_turn')); if(d.movs>0) return window.gameToast("🎮", t('play_turn'));
            const el=document.getElementById('dice-vis'); el.classList.add('rolling'); playSfx('roll');
            setTimeout(()=>{ el.classList.remove('rolling'); const v=Math.ceil(Math.random()*6); window.update({dice:v, movs:v, skips:0}); window.gameToast(t('energy'), `${v} ${t('lines')}`); },500);
        };
        
        window.skipTurn = () => { 
            const d=S.data; if(d.turn===S.role) { const newSkips = (d.skips || 0) + 1; if (newSkips >= 2) window.update({stat:'end'}); else { const t_role = d.turn==='host'?'guest':'host'; window.update({movs:0, turn:t_role, dice:null, skips: newSkips}); window.gameToast(t('pass'), t('turn_skipped')); } } 
        }

        window.clickPt = (id) => {
            const d=S.data; if(d.turn!==S.role || d.movs<=0) return window.gameToast(t('error'), t('roll_dice'));
            if(ren.xr.isPresenting && !placementAccepted && !S.cpu) return window.gameToast("AR SYNC", "Wait Sync");
            playSfx('click');
            if(selPt===null) { selPt=id; window.highlight(id,true); }
            else { if(selPt===id) { window.highlight(id,false); selPt=null; } else { window.tryLine(selPt,id); window.highlight(selPt,false); selPt=null; } }
        }

        window.tryLine = (p1,p2) => {
            const d=S.data; const v1=pts[p1].position; const v2=pts[p2].position;
            if(v1.distanceTo(v2) * currentScale > 1.3 * currentScale) return window.gameToast(t('range'), t('error')); 
            if(d.lines.some(l=>(l.s===p1&&l.e===p2)||(l.s===p2&&l.e===p1))) return window.gameToast(t('occupied'), t('error'));
            if(window.checkCollision(p1, p2)) { playSfx('error'); return window.gameToast(t('blocked'), t('error')); }
            
            const nl=[...d.lines,{s:p1,e:p2,own:S.role}]; const nt=window.checkTri(p1,p2,S.role,nl); const sc={...d.sc}; 
            if(nt.length) { sc[S.role]+=nt.length; playSfx('win'); window.gameToast("CONQUISTA", t('conquest')); } 
            else { window.gameToast("LÍNEA", t('link')); }
            
            let m=d.movs-1; let trn=d.turn; let di=d.dice; if(m===0){ trn=trn==='host'?'guest':'host'; di=null; }
            window.update({lines:nl, tris:[...d.tris,...nt], sc:sc, movs:m, turn:trn, dice:di, skips:0});
        }
        
        window.checkCollision = (p1, p2) => { 
            const A = pts[p1].position; const B = pts[p2].position; const lines = S.data.lines;
            for (let l of lines) { if(l.s===p1 || l.s===p2 || l.e===p1 || l.e===p2) continue; const C = pts[l.s].position; const D = pts[l.e].position; if (window.intersectLine(A, B, C, D)) return true; } return false;
        }

        window.intersectLine = (a, b, c, d) => {
            const x1=a.x, y1=a.z, x2=b.x, y2=b.z, x3=c.x, y3=c.z, x4=d.x, y4=d.z;
            const denom = (y4-y3)*(x2-x1) - (x4-x3)*(y2-y1);
            if (denom === 0) return false;
            const ua = ((x4-x3)*(y1-y3) - (y4-y3)*(x1-x3)) / denom; const ub = ((x2-x1)*(y1-y3) - (y2-y1)*(x1-x3)) / denom;
            return (ua > 0.01 && ua < 0.99 && ub > 0.01 && ub < 0.99); 
        }

        window.checkTri = (p1,p2,o,ls) => { 
            const f=[]; 
            for(let p3=0; p3<pts.length; p3++) {
                if(p3!==p1 && p3!==p2) {
                    if(ls.some(l=>(l.s===p1&&l.e===p3)||(l.s===p3&&l.e===p1)) && ls.some(l=>(l.s===p2&&l.e===p3)||(l.s===p3&&l.e===p2))) {
                        const v1 = pts[p1].position; const v2 = pts[p2].position; const v3 = pts[p3].position;
                        let valid = true; for(let i=0; i<pts.length; i++) if(i!==p1 && i!==p2 && i!==p3 && window.isPointInTriangle(pts[i].position, v1, v2, v3)) { valid=false; break; }
                        if(valid) { const v=[p1,p2,p3].sort(); if(!S.data.tris.some(t=>JSON.stringify([t.p1,t.p2,t.p3].sort())===JSON.stringify(v))) { f.push({p1:v[0],p2:v[1],p3:v[2],own:o}); } }
                    }
                }
            } return f;
        }

        window.confirmLogout = () => { showConfirmModal("LOGOUT", "Exit?", async () => { if (S.room && S.role === 'host') await window.update({ stat: 'end' }); signOut(auth).then(() => location.reload()); }); };
        window.confirmFinishGame = () => { showConfirmModal(t('surrender'), "?", () => window.update({stat: 'end'})); };
        
        window.showModal = (htmlContent) => {
            const modal = document.getElementById('custom-modal');
            const body = document.getElementById('modal-body-content');
            body.innerHTML = htmlContent;
            modal.style.display = 'flex';
        };

        function showConfirmModal(title, message, onConfirm) {
            window.showModal(`
                <h3 class="text-lg font-bold text-cyber mb-3">${title}</h3>
                <p class="text-sm mb-6">${message}</p>
                <div class="flex justify-center gap-4">
                    <button onclick="document.getElementById('custom-modal').style.display='none'" class="btn-neon danger py-2 px-4 text-xs">${t('cancel')}</button>
                    <button id="modal-confirm-btn" class="btn-neon py-2 px-4 text-xs">OK</button>
                </div>
            `);
            document.getElementById('modal-confirm-btn').onclick = () => { document.getElementById('custom-modal').style.display='none'; onConfirm(); };
        }
        
        // --- FIX: SAFETY TIMEOUT PARA EVITAR PANTALLA NEGRA ---
        window.goHome = () => {
            if (ren && ren.xr.isPresenting) { 
                const safetyTimer = setTimeout(() => {
                    console.warn("Forzando salida AR...");
                    performGoHome();
                    window.location.reload(); 
                }, 1500);

                ren.xr.getSession().end()
                    .then(() => clearTimeout(safetyTimer))
                    .catch(e => { console.error(e); clearTimeout(safetyTimer); performGoHome(); }); 
            } else { 
                performGoHome(); 
            }
        }

        function performGoHome() {
            if(roomUnsub) roomUnsub(); roomUnsub=null; S.room = null; S.data = null;
            if(heartbeatInterval) { clearInterval(heartbeatInterval); heartbeatInterval=null; }
            nav('s-menu'); isArHost = false; placementAccepted = false; hideArControls(); isMatchmaking = false;
            if(group) { while(group.children.length>0) group.remove(group.children[0]); }
            arHit = null; reticle.visible = false;
            document.body.classList.remove('ar-active');
            const bg = document.getElementById('bg-canvas'); if(bg) { bg.style.display = 'block'; bg.style.opacity = '1'; }
            window.recenter();
        }
        
        window.goHomeAfterWin = () => { setTimeout(window.goHome, 500); }
        window.setProf = (t,v,el) => {
            S.prof[t]=v; const parent = el.parentNode; 
            Array.from(parent.children).forEach(c=>{ c.classList.remove('active'); if(t==='c') { c.style.boxShadow='none'; c.style.borderColor='#333'; } else { c.style.color='#555'; c.textShadow='none'; c.transform='scale(1)'; } });
            el.classList.add('active'); 
            if(t==='c') { el.style.boxShadow=`0 0 15px ${v}`; el.style.borderColor='#fff'; const i = document.querySelector('#i-pick .opt-i.active'); if(i) { i.style.color=v; i.style.textShadow=`0 0 10px ${v}`; } } 
            else { const col = S.prof.c; el.style.color=col; el.style.textShadow=`0 0 10px ${col}`; el.style.transform='scale(1.2)'; }
        }
        window.showJoin = () => document.getElementById('join-box').classList.toggle('hidden');
        function showLoad(show, txt) { const l = document.getElementById('mini-loader'); if(l) { if(show) { l.classList.remove('hidden'); document.getElementById('mini-load-txt').innerText=txt; } else l.classList.add('hidden'); } }
        function hideArControls() { const c=document.getElementById('ar-controls'); if(c) { c.classList.add('hidden'); c.classList.remove('flex'); } }
        
        function showArControls() { 
            const c=document.getElementById('ar-controls'); if(c) { c.classList.remove('hidden'); c.classList.add('flex'); } 
            if(isArHost) document.getElementById('size-slider-container').style.display='flex';
        }

        const ROOMS_COLL = collection(db, 'artifacts', appId, 'public', 'data', 'rooms');

        // --- SISTEMA DE MATCHMAKING PÚBLICO MEJORADO (FIXED) ---
        window.quickMatch = async () => {
            if(!S.user) return window.systemToast("ERROR", t('login_req'));
            S.cpu=false; isMatchmaking = true;
            
            nav('s-matchmaking');
            document.getElementById('match-status-title').innerText = t('searching');
            document.getElementById('match-status-desc').innerText = t('scanning');
            
            try {
                const q = await getDocs(ROOMS_COLL); 
                let foundId = null;
                // --- FIX: Filtro estricto de 15 segundos para encontrar jugadores ACTIVOS ---
                const activeThreshold = Date.now() - 15000; 

                const openRooms = [];
                q.forEach(d => { 
                    const r = d.data(); 
                    if(r.stat === 'wait' && r.pub === true && r.host !== S.user.uid && !r.guest && r.lastUpdate > activeThreshold) {
                        openRooms.push(d.id);
                    }
                });

                if(openRooms.length > 0) {
                    foundId = openRooms[Math.floor(Math.random() * openRooms.length)].replace('room_','');
                    document.getElementById('match-status-title').innerText = "RIVAL FOUND";
                    document.getElementById('match-status-desc').innerText = "CONNECTING...";
                    setTimeout(() => window.join(foundId), 1500); 
                } else { 
                    document.getElementById('match-status-title').innerText = t('create_room');
                    document.getElementById('match-status-desc').innerText = t('waiting_player');
                    await window.create(true); 
                }
            } catch(e) { 
                console.error(e); 
                nav('s-menu');
                window.systemToast("ERROR", "Net Error"); 
            }
        };

        window.cancelMatchmaking = () => {
            isMatchmaking = false;
            // Si creamos sala, la cerramos para que no quede fantasma
            if(S.room && S.role === 'host') {
                 updateDoc(doc(db,'artifacts',appId,'public', 'data', 'rooms',`room_${S.room}`), { stat: 'end' });
            }
            window.goHome();
        };

        window.createRoom = () => window.create(false);
        window.joinRoom = () => { const c=document.getElementById('code-in').value.toUpperCase(); if(c.length===4) window.join(c); else window.systemToast("ERROR", "CODE 4 CHARS"); };
        
        window.vsCpu = () => {
            if(!S.user) return window.systemToast("ERROR", t('login_req'));
            S.cpu=true; S.role='host'; S.room='CPU';
            S.data={ stat:'play', turn:'host', points:genPoints(), lines:[], tris:[], sc:{host:0,guest:0}, dice:null, movs:0, skips:0, p1:S.prof, p2:{c:'#ffffff',i:'atom'}, scale: 1.0, arPos: null, arRot: null, arScale: null, arAccepted: false };
            window.start();
        };

        window.create = async (pub) => {
            if(!S.user) return; if (S.room) window.goHome(); 
            S.role='host'; const c=Math.random().toString(36).substring(2,6).toUpperCase(); S.room=c;
            
            if(!pub) showLoad(true, "GENERATING...");

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', `room_${c}`);
            try {
                await setDoc(docRef, { host:S.user.uid, hostName: S.user.displayName || "Jugador 1", stat:'wait', pub:pub, turn:'host', points:genPoints(), lines:[], tris:[], sc:{host:0,guest:0}, dice:null, movs:0, skips:0, p1:S.prof, scale:1.0, arPos: null, arRot: null, arScale: 1.0, arAccepted: false, lastUpdate: Date.now() });
                
                // --- FIX: HEARTBEAT PARA SALAS PUBLICAS ---
                if(pub) {
                    if(heartbeatInterval) clearInterval(heartbeatInterval);
                    heartbeatInterval = setInterval(() => {
                        updateDoc(docRef, { lastUpdate: Date.now() }).catch(() => clearInterval(heartbeatInterval));
                    }, 5000);
                } else {
                    showLoad(false);
                    document.getElementById('waiting-code').innerText = c;
                    nav('s-waiting'); 
                }
                window.sub(c); 
            } catch (e) { showLoad(false); window.systemToast("ERROR", "Permisos insuficientes."); }
        }

        window.join = async (c) => {
            if(!S.user) return; S.role='guest'; S.room=c; 
            if(!isMatchmaking) showLoad(true, t('connecting'));
            
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', `room_${c}`);
            try {
                const s = await getDoc(docRef);
                if (!s.exists()) { showLoad(false); window.systemToast("ERROR", "404 ROOM"); S.room = null; return; }
                const d = s.data();
                if (d.guest && d.guest !== S.user.uid) { showLoad(false); window.systemToast("ERROR", t('room_full')); S.room = null; return; }
                
                let up = { guest:S.user.uid, guestName: S.user.displayName || "Jugador 2", stat:'play', p2:S.prof };
                if(d.stat === 'wait') { up = {...up, dice: 6, movs: 6, skips: 0, turn: 'host', lastUpdate: Date.now()}; }
                await updateDoc(docRef, up); window.sub(c); document.getElementById('room-lbl').innerText=c;
            } catch(e) { showLoad(false); window.systemToast("ERROR", "JOIN FAIL"); S.room = null; }
        }
        
        window.sub = (c) => {
            if(roomUnsub) roomUnsub();
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', `room_${c}`);
            roomUnsub = onSnapshot(docRef, s => {
                if(s.exists()) {
                    const d=s.data(); S.data=d;
                    if(d.stat==='play') { 
                        if(heartbeatInterval) { clearInterval(heartbeatInterval); heartbeatInterval=null; }
                        
                        // --- FIX: SIEMPRE usar window.start() para inicializar todo correctamente ---
                        if(document.getElementById('s-game').classList.contains('hidden')) {
                             window.start(); 
                             playSfx('click');
                        }
                        window.ui(); 
                    }
                    else if(d.stat==='end') window.endGame(d);
                } else if(S.room) { window.systemToast("FIN", "Closed."); window.goHome(); }
            });
        }

        window.start = () => { 
            showLoad(false); nav('s-game'); window.init3D(); window.buildBoard(); 
            window.systemToast("GO", "START!"); 
            isArHost = S.cpu || (S.role === 'host'); 
            placementAccepted = !S.cpu && S.data.arAccepted === true;
            const rec = document.getElementById('btn-rec'); if(rec) rec.style.display = 'flex';
        }

        // --- SISTEMA DE RANKING Y FIN DE PARTIDA ---
        window.endGame = async (d) => {
            if(document.getElementById('s-game').classList.contains('hidden')) return;
            nav('win-screen'); playSfx('end');
            if(heartbeatInterval) { clearInterval(heartbeatInterval); heartbeatInterval=null; }
            
            const myS = S.role === 'host' ? d.sc.host : d.sc.guest; 
            const rivS = S.role === 'host' ? d.sc.guest : d.sc.host;
            const win = myS > rivS ? 'WIN' : (myS < rivS ? 'LOSE' : 'DRAW');
            
            const tit = document.getElementById('win-title'); 
            const msg = document.getElementById('win-msg');
            const elo = document.getElementById('elo-change');
            
            let ptsChange = 0;
            let winsChange = 0;
            let lossesChange = 0;
            
            if(win === 'DRAW') { 
                tit.innerText = t('draw'); tit.className = "text-4xl md:text-6xl font-black text-warn mb-2 text-center"; msg.innerText = t('draw_msg');
                ptsChange = 5;
                elo.className = "text-warn font-bold text-lg mb-6";
            }
            else if(win === 'WIN') { 
                tit.innerText = t('victory'); tit.className = "text-4xl md:text-6xl font-black text-neon mb-2 animate-pulse text-center"; msg.innerText = t('win_msg');
                ptsChange = 25;
                winsChange = 1;
                elo.className = "text-neon font-bold text-lg mb-6 animate-bounce";
            }
            else { 
                tit.innerText = t('defeat'); tit.className = "text-4xl md:text-6xl font-black text-hot mb-2 text-center"; msg.innerText = t('lose_msg');
                ptsChange = -10;
                lossesChange = 1;
                elo.className = "text-hot font-bold text-lg mb-6";
            }
            
            if(!S.cpu && S.user) {
                const newPoints = (S.points || 1000) + ptsChange;
                S.points = newPoints; 
                S.wins += winsChange;
                S.losses += lossesChange;
                elo.innerText = (ptsChange >= 0 ? "+" : "") + ptsChange + " " + t('pts');
                
                try {
                    const userRef = doc(db, 'artifacts', appId, 'users', S.user.uid);
                    await updateDoc(userRef, { 
                        points: increment(ptsChange),
                        wins: increment(winsChange),
                        losses: increment(lossesChange)
                    });
                } catch(e) { console.error("Error saving stats", e); }
            } else {
                elo.innerText = "TRAINING (No Pts)";
            }

            document.getElementById('final-p1').innerText = myS; document.getElementById('final-p2').innerText = rivS;
            hideArControls();
        }

        // --- SISTEMA DE LEADERBOARD ---
        function mulberry32(a) {
            return function() {
              var t = a += 0x6D2B79F5;
              t = Math.imul(t ^ t >>> 15, t | 1);
              t ^= t + Math.imul(t ^ t >>> 7, t | 61);
              return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }

        function getDailyBots() {
            const todayStr = new Date().toDateString();
            let seed = 0;
            for(let i=0; i<todayStr.length; i++) seed += todayStr.charCodeAt(i);
            const rng = mulberry32(seed);

            const bots = [
                "CyberKing", "NeonViper", "GlitchPro", "ArMan", "PolyGon", 
                "VoxelQueen", "PixelHunter", "MatrixNeo", "GridRunner", "LoopBreaker"
            ];

            return bots.map(name => {
                const score = Math.floor(rng() * 4000) + 1200; 
                const wins = Math.floor(score / 30) + Math.floor(rng() * 20);
                const losses = Math.floor(rng() * 40);
                return { displayName: name, points: score, wins, losses, isBot: true };
            });
        }

        window.showLeaderboard = async () => {
            if(!S.user) return window.systemToast("ERROR", t('login_req'));
            
            window.showModal(`
                <h3 class="text-lg font-bold text-cyber mb-4 border-b border-cyber/30 pb-2">${t('ranking')}</h3>
                <div class="rank-header">
                    <div style="width:25px">#</div>
                    <div style="flex-grow:1">${t('agent')}</div>
                    <div style="width:50px; text-align:center">W / L</div>
                    <div style="width:50px; text-align:right">${t('pts')}</div>
                </div>
                <div id="lb-list" class="flex flex-col gap-1 mb-4 h-64 overflow-y-auto">
                    <div class="text-center mt-10"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-cyber mx-auto"></div></div>
                </div>
                <div class="bg-white/10 p-2 rounded flex justify-between items-center text-xs border-t border-white/10 mt-2">
                    <span class="text-gray-400">YOUR RANK:</span>
                    <span class="text-neon font-bold" id="my-rank-pts">${S.points} ${t('pts')}</span>
                </div>
            `);

            try {
                let allPlayers = getDailyBots();
                const myData = { 
                    displayName: S.user.displayName || "YO", 
                    points: S.points || 1000, 
                    wins: S.wins || 0, 
                    losses: S.losses || 0,
                    isMe: true 
                };
                allPlayers.push(myData);
                allPlayers.sort((a,b) => b.points - a.points);
                
                const list = document.getElementById('lb-list');
                list.innerHTML = "";
                
                allPlayers.forEach((u, i) => {
                    const rankClass = i === 0 ? "rank-1" : (i === 1 ? "rank-2" : (i === 2 ? "rank-3" : ""));
                    const name = u.displayName.split(' ')[0].toUpperCase();
                    const pts = u.points;
                    const w = u.wins || 0;
                    const l = u.losses || 0;
                    const isMeClass = u.isMe ? "is-me" : "";
                    
                    list.innerHTML += `
                        <div class="rank-row ${rankClass} ${isMeClass}">
                            <div class="rank-pos">${i+1}</div>
                            <div class="rank-name ${u.isMe ? 'text-neon' : 'text-white/80'}">${name}</div>
                            <div class="rank-stats"><span class="stat-w">${w}</span> / <span class="stat-l">${l}</span></div>
                            <div class="rank-pts">${pts}</div>
                        </div>
                    `;
                });
            } catch(e) {
                document.getElementById('lb-list').innerHTML = "<p class='text-red-500 text-xs'>Error</p>";
            }
        };

        window.copyLink = (txt) => {
            const input = document.createElement('input');
            input.value = txt;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
            window.systemToast("COPY", "Link Copied");
        };

        window.update = (o) => {
            if(S.cpu) { Object.assign(S.data,o); if(S.data.stat === 'end') window.endGame(S.data); else window.ui(); } 
            else { updateDoc(doc(db,'artifacts',appId,'public', 'data', 'rooms',`room_${S.room}`), {...o, lastUpdate: Date.now()}); }
        }
        
        window.ui = () => { 
            const d=S.data;
            document.getElementById('sc-p1').innerText = S.role==='host'?d.sc.host:d.sc.guest;
            document.getElementById('sc-p2').innerText = S.role==='host'?d.sc.guest:d.sc.host;
            document.getElementById('room-lbl').innerText = S.room || '--'; 
            
            const b=document.getElementById('mov-hud'); const dv=document.getElementById('dice-vis');
            if(d.turn===S.role && d.movs>0) { b.style.opacity=1; document.getElementById('mov-cnt').innerText=d.movs; dv.innerText=d.dice; dv.style.borderColor='#00f3ff'; dv.style.color='#00f3ff'; }
            else { b.style.opacity=0; dv.innerText=d.dice||"?"; dv.style.borderColor=d.dice?'#00f3ff':'#444'; dv.style.color=d.dice?'#00f3ff':'#555'; }

            if(ren && ren.xr.isPresenting) {
                document.getElementById('btn-exit-ar').classList.remove('hidden');
                document.getElementById('pc-controls').style.display = 'none'; 

                if(d.arPos && (!S.cpu || placed)) { 
                    if(!S.cpu) {
                        const pos = new THREE.Vector3().fromArray(d.arPos); const rot = new THREE.Euler().fromArray(d.arRot);
                        if (!placed || !d.arAccepted) { 
                            group.position.copy(pos); group.rotation.copy(rot); group.visible = true; 
                            placed = true; reticle.visible = false; 
                            if(ghostGroup) ghostGroup.visible = false; 
                        }
                        currentScale = d.arScale || 1.0; 
                        group.scale.set(currentScale, currentScale, currentScale);
                        document.getElementById('size-slider').value = currentScale;
                        placementAccepted = d.arAccepted;
                    }
                    if (S.cpu || d.arAccepted) { 
                        hideArControls(); 
                        document.getElementById('ar-instructions').style.display='none';
                        if(isArHost) document.getElementById('size-slider-container').style.display='flex'; 
                    } else {
                        showArControls();
                        document.getElementById('ar-instr-txt').innerText = t('ar_adjust');
                        document.getElementById('btn-ar-accept').innerText = isArHost ? t('fix') : t('waiting_player');
                        document.getElementById('btn-ar-accept').disabled = !isArHost; 
                        document.getElementById('btn-ar-recal').style.display = isArHost ? 'inline-block' : 'none';
                    }
                } else if (isArHost && !placed) { 
                    document.getElementById('ar-instructions').style.display='block';
                    document.getElementById('ar-instr-txt').innerHTML = `<span class='text-neon'>${t('ar_scan')}</span><br>${t('ar_tap_fix')}`;
                } 
            } else { 
                document.getElementById('btn-exit-ar').classList.add('hidden');
                document.getElementById('pc-controls').style.display = 'flex';
                document.getElementById('ar-instructions').style.display='none';
                document.getElementById('size-slider-container').style.display='none';
                currentScale = d.scale || 1.0; 
                if(group) group.scale.set(currentScale, currentScale, currentScale); 
            }
            window.draw();
            if(d.stat === 'play') {
                if(S.cpu && d.turn==='guest') { if(d.movs===0 && !d.dice) setTimeout(()=>window.update({dice:Math.ceil(Math.random()*6),movs:3, skips:0}),1000); else if(d.movs>0) setTimeout(window.cpuMove,1500); }
                window.checkGameEndCondition(); 
            }
        }

        window.checkGameEndCondition = () => {
            const d = S.data; if(d.stat !== 'play') return;
            let movesPossible = false;
            for(let i=0; i<pts.length; i++) {
                for(let j=i+1; j<pts.length; j++) {
                    const dist = pts[i].position.distanceTo(pts[j].position);
                    if(dist < 1.3 && !d.lines.some(l=>(l.s===i&&l.e===j)||(l.s===j&&l.e===i))) { if(!window.checkCollision(i, j)) { movesPossible = true; break; } }
                } if(movesPossible) break;
            }
            if(!movesPossible) { window.update({stat: 'end'}); }
        }

        window.cpuMove = () => { 
            let m=null; 
            for(let i=0; i<pts.length; i++) { for(let j=i+1; j<pts.length; j++) { if(pts[i].position.distanceTo(pts[j].position)<1.3 && !S.data.lines.some(l=>(l.s===i&&l.e===j)||(l.s===j&&l.e===i)) && !window.checkCollision(i,j)) { const testLines = [...S.data.lines, {s:i,e:j,own:'guest'}]; if (window.checkTri(i, j, 'guest', testLines).length > 0) { m={s:i,e:j}; break; } } } if(m) break; }
            if(!m) { const candidates = []; for(let i=0;i<pts.length;i++) for(let j=i+1;j<pts.length;j++) if(pts[i].position.distanceTo(pts[j].position)<1.3 && !S.data.lines.some(l=>(l.s===i&&l.e===j)||(l.s===j&&l.e===i)) && !window.checkCollision(i,j)) candidates.push({s:i,e:j}); if(candidates.length > 0) m = candidates[Math.floor(Math.random() * candidates.length)]; }
            if(m) { const nl=[...S.data.lines,{s:m.s,e:m.e,own:'guest'}]; const nt=window.checkTri(m.s,m.e,'guest',nl); const sc={...S.data.sc}; if(nt.length) sc.guest+=nt.length; let mo=S.data.movs-1; let trn=S.data.turn; let di=S.data.dice; if(mo===0){trn='host'; di=null;} window.update({lines:nl, tris:[...S.data.tris,...nt], sc:sc, movs:mo, turn:trn, dice:di, skips:0}); } else { window.update({movs:0, turn:'host', dice:null, skips: S.data.skips + 1}); }
        }

        window.checkAR = () => {
            const el = document.getElementById('ar-status');
            if('xr' in navigator) {
                navigator.xr.isSessionSupported('immersive-ar').then(ok => {
                    el.innerHTML= ok ? '<span class="text-neon font-bold">AR OK</span>' : '3D MODE';
                    if(ok) {
                        document.getElementById('btn-start-ar-float').classList.remove('hidden');
                        if(!arInitialized) window.init3D();
                    }
                });
            } else el.innerText="3D MODE (PC)";
        }

        window.recenter = () => {
            if (controls) {
                controls.reset();
                controls.target.set(0, 0, 0); 
            }
            if (cam) cam.position.set(0, 2, 3); 
            if (group) {
                if (!ren || !ren.xr.isPresenting) {
                    group.position.set(0, 0, 0);
                    group.rotation.set(0, 0, 0);
                }
            }
        }

        window.manualScale = (val) => {
            currentScale = parseFloat(val);
            if(group) group.scale.set(currentScale, currentScale, currentScale);
            if(ren && ren.xr.isPresenting && isArHost) {
                window.update({ arScale: currentScale });
            }
        }

        window.init3D = () => {
            if(arInitialized) return; arInitialized = true;
            scene=new THREE.Scene(); cam=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.01,20);
            ren=new THREE.WebGLRenderer({antialias:true, alpha:true}); 
            ren.setSize(innerWidth,innerHeight); ren.xr.enabled=true;
            ren.domElement.style.position='absolute'; ren.domElement.style.top='0'; ren.domElement.style.zIndex='1';
            document.body.appendChild(ren.domElement);
            
            arBtn = ARButton.createButton(ren, { requiredFeatures: ['hit-test'], optionalFeatures: ['dom-overlay'], domOverlay: { root: document.body } });
            document.getElementById('ar-zone').appendChild(arBtn);

            ren.xr.addEventListener('sessionstart', async (e)=>{
                document.body.classList.add('ar-active');
                document.getElementById('btn-start-ar-float').classList.add('hidden'); 
                document.getElementById('btn-rec').style.display='none'; 
                if(controls) controls.enabled = false; 
                
                try {
                    const session = ren.xr.getSession();
                    // --- FIX: SOLICITAR VIEWER SPACE PARA HIT TEST (CORRIGE DETECCIÓN) ---
                    const viewerSpace = await session.requestReferenceSpace('viewer');
                    arRefSpace = await session.requestReferenceSpace('local');
                    
                    try { 
                        arHit = await session.requestHitTestSource({ space: viewerSpace }); 
                    } catch(err) { 
                        console.warn("Hit Test no soportado, modo aéreo activo"); 
                        arHit = null; 
                    }
                } catch (e) { console.error("Error AR", e); window.goHome(); return; }
                
                placed = false; group.visible = false; reticle.visible = true; 
                document.getElementById('ar-instructions').style.display = 'block';
                document.getElementById('ar-instr-txt').innerHTML = t('scanning');
            });

            ren.xr.addEventListener('sessionend',()=>{ 
                document.body.classList.remove('ar-active'); 
                const bg = document.getElementById('bg-canvas'); if(bg) { bg.style.opacity = '1'; bg.style.display = 'block'; }
                if(controls) controls.enabled = true; 
                
                // --- FIX: LIMPIEZA PARA EVITAR GLITCHES ---
                arHit = null;
                if(reticle) reticle.visible = false;
                
                performGoHome();
            });
            
            scene.add(new THREE.HemisphereLight(0xffffff,0x222222,3)); group=new THREE.Group(); scene.add(group);
            
            reticle=new THREE.Group();
            const rRing = new THREE.Mesh(new THREE.RingGeometry(0.2,0.22,32).rotateX(-Math.PI/2),new THREE.MeshBasicMaterial({color:0x00f3ff}));
            const rCross1 = new THREE.Mesh(new THREE.PlaneGeometry(0.3, 0.02).rotateX(-Math.PI/2), new THREE.MeshBasicMaterial({color: 0x00f3ff}));
            const rCross2 = new THREE.Mesh(new THREE.PlaneGeometry(0.02, 0.3).rotateX(-Math.PI/2), new THREE.MeshBasicMaterial({color: 0x00f3ff}));
            reticle.add(rRing); reticle.add(rCross1); reticle.add(rCross2);
            reticle.visible=false; reticle.matrixAutoUpdate=false; scene.add(reticle);
            
            ghostGroup = new THREE.Group(); scene.add(ghostGroup);

            ray=new THREE.Raycaster(); ren.setAnimationLoop(window.loop);
            
            const handleInput = (clientX, clientY) => {
                if (ren.xr.isPresenting && !placed && isArHost) { window.doPlace(); return; }

                const m = new THREE.Vector2((clientX / window.innerWidth) * 2 - 1, -(clientY / window.innerHeight) * 2 + 1);
                ray.setFromCamera(m, cam);
                const h = ray.intersectObjects(group.children, true);
                const obj = h.find(x => x.object.parent && x.object.parent.userData.id !== undefined);
                if (obj) { window.clickPt(obj.object.parent.userData.id); }
            };

            window.addEventListener('touchstart', (e) => {
                if(e.target.closest('.interactive') || e.target.closest('#ar-zone') || e.target.closest('#size-slider-container')) return;
                if (e.touches.length === 1) { const touch = e.touches[0]; handleInput(touch.clientX, touch.clientY); }
            }, {passive: false});

            window.addEventListener('click', (e) => {
                if(e.target.closest('.interactive') || e.target.closest('#ar-zone') || e.target.closest('#size-slider-container')) return;
                if(!ren.xr.isPresenting) { handleInput(e.clientX, e.clientY); }
            });
            
            controls=new OrbitControls(cam,ren.domElement); 
            controls.enableDamping = true;
            window.recenter();
        }

        window.loop = (t, frame) => {
            if(controls && controls.enabled) controls.update(); 
            if(ren.xr.isPresenting) {
                if(!arRefSpace) return; 
                
                if(!placed && isArHost) {
                    reticle.visible = true; if(ghostGroup) ghostGroup.visible = true;
                    let hitFound = false;
                    
                    if (frame && arHit) {
                        const h = frame.getHitTestResults(arHit);
                        if(h.length > 0) {
                            const hitPose = h[0].getPose(arRefSpace);
                            reticle.matrix.fromArray(hitPose.transform.matrix);
                            reticle.matrixAutoUpdate = false;
                            reticle.children.forEach(c => c.material.color.setHex(0x39ff14));
                            hitFound = true;
                            document.getElementById('ar-instr-txt').innerHTML = `<span class='text-neon'>${t('ar_floor')}</span><br>${t('ar_tap_fix')}`;
                        }
                    }
                    if(!hitFound && frame) {
                        const viewerPose = frame.getViewerPose(arRefSpace);
                        if(viewerPose) {
                            reticle.matrixAutoUpdate = true;
                            const p = viewerPose.transform.position;
                            const r = viewerPose.transform.orientation;
                            const dir = new THREE.Vector3(0, 0, -0.5).applyQuaternion(new THREE.Quaternion(r.x, r.y, r.z, r.w));
                            const targetPos = new THREE.Vector3(p.x, p.y, p.z).add(dir);
                            reticle.position.lerp(targetPos, 0.2);
                            reticle.lookAt(p.x, p.y, p.z); 
                            reticle.children.forEach(c => c.material.color.setHex(0xffcc00));
                            document.getElementById('ar-instr-txt').innerHTML = `<span class='text-warn'>${t('ar_air')}</span><br>${t('ar_tap_fix')}`;
                        }
                    }
                    if(ghostGroup) { 
                        if(reticle.matrixAutoUpdate) { ghostGroup.position.copy(reticle.position); ghostGroup.rotation.copy(reticle.rotation); }
                        else { ghostGroup.position.setFromMatrixPosition(reticle.matrix); ghostGroup.rotation.setFromRotationMatrix(reticle.matrix); }
                    }
                }
            }
            ren.render(scene,cam);
        }

        function createIconSprite(iconName, color) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.font = '900 100px "Font Awesome 6 Free"';
            ctx.fillStyle = color;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            let char = '\uf005'; 
            if(iconName === 'gem') char = '\uf3a5';
            else if(iconName === 'bolt') char = '\uf0e7';
            else if(iconName === 'atom') char = '\uf5d2';
            ctx.fillText(char, 64, 64);
            const tex = new THREE.CanvasTexture(canvas);
            const mat = new THREE.SpriteMaterial({ map: tex, transparent: true });
            const sprite = new THREE.Sprite(mat);
            sprite.scale.set(0.3, 0.3, 0.3);
            return sprite;
        }

        window.draw = () => {
            if(!S.data || !pts.length) return;
            const d=S.data;
            pts.forEach((m,i)=>{
                const own = d.lines.filter(l=>l.s===i||l.e===i).map(l=>l.own);
                const baseCol = i===selPt ? '#ffffff' : (own.includes('host') && own.includes('guest') ? '#ff00ff' : (own.includes('host') ? d.p1.c : (own.includes('guest') ? d.p2.c : '#333')));
                m.material.color.set(baseCol);
                m.material.emissive.set(baseCol);
            });
            group.children.filter(c=>c.userData.type==='line'||c.userData.type==='tri'||c.userData.type==='icon').forEach(c=>group.remove(c));

            d.lines.forEach(l=>{
                const ptsLine = [pts[l.s].position, pts[l.e].position];
                const geo = new THREE.TubeGeometry(new THREE.CatmullRomCurve3(ptsLine), 4, 0.02, 8, false);
                const col = l.own==='host'?d.p1.c:d.p2.c;
                const mesh = new THREE.Mesh(geo, new THREE.MeshBasicMaterial({color:col}));
                mesh.userData.type='line'; group.add(mesh);
            });

            d.tris.forEach(t=>{
                const p1 = pts[t.p1].position; const p2 = pts[t.p2].position; const p3 = pts[t.p3].position;
                const g = new THREE.BufferGeometry().setFromPoints([p1, p2, p3]);
                const col = t.own==='host'?d.p1.c:d.p2.c;
                const icon = t.own==='host'?d.p1.i:d.p2.i;
                
                const mesh = new THREE.Mesh(g, new THREE.MeshBasicMaterial({color:col, opacity:0.3, transparent:true, side:THREE.DoubleSide}));
                mesh.userData.type='tri'; group.add(mesh);
                
                const center = new THREE.Vector3().addVectors(p1, p2).add(p3).divideScalar(3);
                const sprite = createIconSprite(icon, col);
                sprite.position.copy(center);
                sprite.userData.type = 'icon';
                group.add(sprite);
            });
        }
        
        window.highlight = (id,on) => { if(on) pts[id].scale.set(1.5,1.5,1.5); else pts[id].scale.set(1,1,1); }

        window.acceptScaleAndPosition = () => {
            if (!ren.xr.isPresenting || !isArHost || !placed) return;
            const pos = group.position.toArray(); const rot = group.rotation.toArray().slice(0, 3);
            window.update({ arPos: pos, arRot: rot, arScale: currentScale, arAccepted: true });
            window.gameToast(t('ar_sync'), t('ar_sync_msg'));
        }

        window.recalibrate = () => {
            if (!ren.xr.isPresenting || !isArHost) return;
            placed = false; group.visible = false; reticle.visible = true; placementAccepted = false;
            window.update({ arPos: null, arRot: null, arScale: 1.0, arAccepted: false });
            showArControls();
        }
        
        window.gameToast = (t,m) => {
            const e=document.getElementById('game-toast');
            document.getElementById('t-head').innerText=t; document.getElementById('t-body').innerText=m;
            e.classList.add('show'); setTimeout(()=>e.classList.remove('show'),3000);
        }
        
        window.systemToast = (t,m) => {
            const e=document.getElementById('toast');
            document.getElementById('s-head').innerText="SYSTEM"; document.getElementById('s-body').innerText=`${t}: ${m}`;
            e.classList.add('show'); setTimeout(()=>e.classList.remove('show'),3000);
        }
    </script>
</body>
</html>
